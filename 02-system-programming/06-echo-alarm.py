#!/usr/bin/env python
#
# Usage: echo_alarm.py -s <seconds>
# Creates a echo server that shuts down after <seconds>
# Listens to port 9999
# Shuts down using alarm signal

import signal
import SocketServer
import sys

class MyTcpHandler(SocketServer.BaseRequestHandler):
  def setup(self):
    print "Connection from {}".format(self.client_address[0])

  def handle(self):
    self.data = self.request.recv(1024).strip()
    print "{} wrote:".format(self.client_address[0])
    print self.data
    self.request.sendall(self.data.upper())

def alarm_handler(signum, frm):
  print "Terminating."
  exit()

if len(sys.argv) != 3 or sys.argv[1] != "-s":
  print "Usage: tcp_server.py -s <SECONDS>" 
  exit()

timeout = int(sys.argv[2])
signal.signal(signal.SIGALRM, alarm_handler)
signal.alarm(int(timeout))

print "Starting server..."
SocketServer.TCPServer.allow_reuse_address = True
server = SocketServer.TCPServer(('localhost', 9999), MyTcpHandler)
server.serve_forever()

