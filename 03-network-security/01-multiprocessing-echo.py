#!/usr/bin/env python
#
# Echo server using multiprocessing, can accept more than one client
# Up to 5 clients simultaneously

import signal
import socket
from multiprocessing import Process

tcpSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
tcpSocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

HOST = "0.0.0.0"
PORT = 8000
tcpSocket.bind((HOST, PORT))
tcpSocket.listen(1)

class WorkerProcess(Process):
	def __init__(self):
		Process.__init__(self)

	def run(self):
		while True:
			(client, addr) = tcpSocket.accept()
			print "Client connected! From ", addr

			client.send("Connection established!\n")
			data = client.recv(2048)
			while data:
				client.send(data)
				data = client.recv(2048)

for i in range(5):
	worker = WorkerProcess()
	worker.daemon = True
	worker.start()

def exit_handler(signum, frm):
	print "Terminating..."
	exit()
signal.signal(signal.SIGINT, exit_handler)

while True:
	pass
